services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.prod.api
    # Remove container_name to allow scaling
    ports:
      - "${API_EXTERNAL_PORT:-3000}:${API_INTERNAL_PORT:-3000}"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongo:27017/bb-db}
      - PORT=${API_INTERNAL_PORT:-3000}
      - HOST=${HOST:-0.0.0.0}
      - LOG_LEVEL=${LOG_LEVEL:-warn}
      - ENABLE_REQUEST_LOGGING=${ENABLE_REQUEST_LOGGING:-false}
      - DB_MAX_POOL_SIZE=${DB_MAX_POOL_SIZE:-20}
      - DB_SERVER_SELECTION_TIMEOUT=${DB_SERVER_SELECTION_TIMEOUT:-10000}
      - DB_SOCKET_TIMEOUT=${DB_SOCKET_TIMEOUT:-60000}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://yourdomain.com}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60000}
      - SESSION_SECRET=${SESSION_SECRET}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      mongo:
        condition: service_healthy
        restart: true
    networks:
      - basketball-network
    restart: ${RESTART_POLICY:-unless-stopped}
    # Scaling configuration
    deploy:
      replicas: ${API_REPLICAS:-2}
      resources:
        limits:
          cpus: "${API_CPU_LIMIT:-1.0}"
          memory: "${API_MEMORY_LIMIT:-512M}"
        reservations:
          cpus: "${API_CPU_RESERVATION:-0.25}"
          memory: "${API_MEMORY_RESERVATION:-128M}"
      restart_policy:
        condition: ${DEPLOY_RESTART_CONDITION:-on-failure}
        delay: ${DEPLOY_RESTART_DELAY:-5s}
        max_attempts: ${DEPLOY_MAX_ATTEMPTS:-3}
        window: ${DEPLOY_RESTART_WINDOW:-120s}
      update_config:
        parallelism: ${DEPLOY_UPDATE_PARALLELISM:-1}
        delay: ${DEPLOY_UPDATE_DELAY:-10s}
        failure_action: ${DEPLOY_UPDATE_FAILURE_ACTION:-rollback}
        monitor: ${DEPLOY_UPDATE_MONITOR:-60s}
        max_failure_ratio: ${DEPLOY_UPDATE_MAX_FAILURE_RATIO:-0.3}
        order: ${DEPLOY_UPDATE_ORDER:-stop-first}
      rollback_config:
        parallelism: ${DEPLOY_ROLLBACK_PARALLELISM:-1}
        delay: ${DEPLOY_ROLLBACK_DELAY:-0s}
        failure_action: ${DEPLOY_ROLLBACK_FAILURE_ACTION:-pause}
        monitor: ${DEPLOY_ROLLBACK_MONITOR:-60s}
        max_failure_ratio: ${DEPLOY_ROLLBACK_MAX_FAILURE_RATIO:-0.3}
        order: ${DEPLOY_ROLLBACK_ORDER:-stop-first}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${API_INTERNAL_PORT:-3000}/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-15}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-10}s
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-60}s
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=api,environment=production"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.prod.frontend
    # Remove container_name to allow scaling
    ports:
      - "${FRONTEND_EXTERNAL_PORT:-80}:${FRONTEND_INTERNAL_PORT:-80}"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - VITE_API_URL=${VITE_API_URL:-https://api.yourdomain.com}
    depends_on:
      api:
        condition: service_healthy
        restart: true
    networks:
      - basketball-network
    restart: ${RESTART_POLICY:-unless-stopped}
    # Scaling configuration
    deploy:
      replicas: ${FRONTEND_REPLICAS:-2}
      resources:
        limits:
          cpus: "${FRONTEND_CPU_LIMIT:-0.5}"
          memory: "${FRONTEND_MEMORY_LIMIT:-256M}"
        reservations:
          cpus: "${FRONTEND_CPU_RESERVATION:-0.1}"
          memory: "${FRONTEND_MEMORY_RESERVATION:-64M}"
      restart_policy:
        condition: ${DEPLOY_RESTART_CONDITION:-on-failure}
        delay: ${DEPLOY_RESTART_DELAY:-5s}
        max_attempts: ${DEPLOY_MAX_ATTEMPTS:-3}
        window: ${DEPLOY_RESTART_WINDOW:-120s}
      update_config:
        parallelism: ${DEPLOY_UPDATE_PARALLELISM:-1}
        delay: ${DEPLOY_UPDATE_DELAY:-10s}
        failure_action: ${DEPLOY_UPDATE_FAILURE_ACTION:-rollback}
        monitor: ${DEPLOY_UPDATE_MONITOR:-60s}
        max_failure_ratio: ${DEPLOY_UPDATE_MAX_FAILURE_RATIO:-0.3}
        order: ${DEPLOY_UPDATE_ORDER:-stop-first}
      rollback_config:
        parallelism: ${DEPLOY_ROLLBACK_PARALLELISM:-1}
        delay: ${DEPLOY_ROLLBACK_DELAY:-0s}
        failure_action: ${DEPLOY_ROLLBACK_FAILURE_ACTION:-pause}
        monitor: ${DEPLOY_ROLLBACK_MONITOR:-60s}
        max_failure_ratio: ${DEPLOY_ROLLBACK_MAX_FAILURE_RATIO:-0.3}
        order: ${DEPLOY_ROLLBACK_ORDER:-stop-first}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${FRONTEND_INTERNAL_PORT:-80}/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-15}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-10}s
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-45}s
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-3}"
        labels: "service=frontend,environment=production"

  mongo:
    image: mongo:7-jammy
    # Remove container_name to allow scaling (though typically only 1 replica for MongoDB)
    environment:
      - MONGO_INITDB_DATABASE=${DATABASE_NAME:-bb-db}
    volumes:
      - mongo_data_prod:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    networks:
      - basketball-network
    restart: ${RESTART_POLICY:-unless-stopped}
    # MongoDB scaling configuration (typically 1 replica, but configurable)
    deploy:
      replicas: ${MONGO_REPLICAS:-1}
      resources:
        limits:
          cpus: "${MONGO_CPU_LIMIT:-1.0}"
          memory: "${MONGO_MEMORY_LIMIT:-1G}"
        reservations:
          cpus: "${MONGO_CPU_RESERVATION:-0.5}"
          memory: "${MONGO_MEMORY_RESERVATION:-512M}"
      restart_policy:
        condition: ${DEPLOY_RESTART_CONDITION:-on-failure}
        delay: ${DEPLOY_RESTART_DELAY:-5s}
        max_attempts: ${DEPLOY_MAX_ATTEMPTS:-3}
        window: ${DEPLOY_RESTART_WINDOW:-120s}
      placement:
        constraints:
          - ${MONGO_PLACEMENT_CONSTRAINT:-node.role == manager}
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: ${HEALTH_CHECK_RETRIES:-5}
      start_period: ${HEALTH_CHECK_START_PERIOD:-30}s
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=database,environment=production"
    # Don't expose MongoDB port in production for security
    # ports:
    #   - "${MONGODB_EXTERNAL_PORT:-27017}:27017"

volumes:
  mongo_data_prod:
    driver: local

networks:
  basketball-network:
    driver: ${NETWORK_DRIVER:-bridge}
    driver_opts:
      com.docker.network.bridge.name: ${NETWORK_BRIDGE_NAME:-basketball-br0}
      com.docker.network.bridge.enable_icc: ${NETWORK_ENABLE_ICC:-true}
      com.docker.network.bridge.enable_ip_masquerade: ${NETWORK_ENABLE_IP_MASQUERADE:-true}
      com.docker.network.driver.mtu: ${NETWORK_MTU:-1500}
    ipam:
      driver: ${IPAM_DRIVER:-default}
      config:
        - subnet: ${NETWORK_SUBNET:-172.20.0.0/16}
          gateway: ${NETWORK_GATEWAY:-172.20.0.1}
    labels:
      - "com.basketball.network.environment=production"
      - "com.basketball.network.version=${COMPOSE_VERSION:-1.0}"