services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.prod.api
    container_name: basketball-api-staging
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    environment:
      - NODE_ENV=${NODE_ENV:-staging}
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongo:27017/bb-db-staging}
      - PORT=${PORT:-3000}
      - HOST=${HOST:-0.0.0.0}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ENABLE_REQUEST_LOGGING=${ENABLE_REQUEST_LOGGING:-true}
      - DB_MAX_POOL_SIZE=${DB_MAX_POOL_SIZE:-10}
      - DB_SERVER_SELECTION_TIMEOUT=${DB_SERVER_SELECTION_TIMEOUT:-10000}
      - DB_SOCKET_TIMEOUT=${DB_SOCKET_TIMEOUT:-60000}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://staging.yourdomain.com}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-500}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60000}
      - SESSION_SECRET=${SESSION_SECRET}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      mongo:
        condition: service_healthy
        restart: true
    networks:
      - basketball-network
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${PORT:-3000}/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-30}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-15}s
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-60}s
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=api,environment=staging"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.prod.frontend
    container_name: basketball-frontend-staging
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - NODE_ENV=${NODE_ENV:-staging}
      - VITE_API_URL=${VITE_API_URL:-https://staging-api.yourdomain.com}
    depends_on:
      api:
        condition: service_healthy
        restart: true
    networks:
      - basketball-network
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-30}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-15}s
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-60}s
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=frontend,environment=staging"

  mongo:
    image: mongo:7-jammy
    container_name: basketball-mongo-staging
    environment:
      - MONGO_INITDB_DATABASE=${DATABASE_NAME:-bb-db-staging}
    volumes:
      - mongo_data_staging:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    networks:
      - basketball-network
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: ${HEALTH_CHECK_RETRIES:-5}
      start_period: ${HEALTH_CHECK_START_PERIOD:-30}s
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=database,environment=staging"
    # Expose MongoDB port in staging for debugging (optional)
    ports:
      - "${MONGODB_PORT:-27017}:27017"

volumes:
  mongo_data_staging:
    driver: local

networks:
  basketball-network:
    driver: bridge